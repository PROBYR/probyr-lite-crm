<!DOCTYPE html>
<html>
<head>
    <title>CRM Test Interface</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>CRM Interface Test</h1>
    
    <div class="test-section">
        <h2>1. Test API Connection</h2>
        <button onclick="testApiHealth()">Test Health Check</button>
        <button onclick="loadContacts()">Load Contacts</button>
        <div id="apiResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Test Contact Management</h2>
        <button onclick="openContactProfile(278)">Open Contact Profile (ID: 278)</button>
        <button onclick="testContactSelection()">Test Contact Selection</button>
        <div id="contactResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Contact List with Actions</h2>
        <div id="contactsList"></div>
    </div>

    <script>
        // Test functions
        async function testApiHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                document.getElementById('apiResult').innerHTML = `<strong>Health Check:</strong> ${data.status} - ${data.message}`;
            } catch (error) {
                document.getElementById('apiResult').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        async function loadContacts() {
            try {
                const response = await fetch('/api/contacts');
                const contacts = await response.json();
                document.getElementById('apiResult').innerHTML = `<strong>Loaded ${contacts.length} contacts</strong>`;
                displayContactsList(contacts.slice(0, 5)); // Show first 5 contacts
            } catch (error) {
                document.getElementById('apiResult').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        function displayContactsList(contacts) {
            const container = document.getElementById('contactsList');
            container.innerHTML = contacts.map(contact => `
                <div style="padding: 10px; border: 1px solid #eee; margin: 5px 0; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <input type="checkbox" onchange="toggleSelection(${contact.id})" id="check_${contact.id}">
                        <strong>${contact.name}</strong> - ${contact.email || 'No email'} - ${contact.company_name || 'No company'}
                    </div>
                    <div>
                        <button onclick="viewContact(${contact.id})">üëÅÔ∏è View</button>
                        <button onclick="editContact(${contact.id})">‚úèÔ∏è Edit</button>
                        <button onclick="deleteContact(${contact.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        let selectedContacts = new Set();

        function toggleSelection(contactId) {
            if (selectedContacts.has(contactId)) {
                selectedContacts.delete(contactId);
            } else {
                selectedContacts.add(contactId);
            }
            console.log('Selected contacts:', Array.from(selectedContacts));
            document.getElementById('contactResult').innerHTML = `<strong>Selected:</strong> ${Array.from(selectedContacts).join(', ')}`;
        }

        async function viewContact(contactId) {
            try {
                const response = await fetch(`/api/contacts/${contactId}`);
                const contact = await response.json();
                document.getElementById('contactResult').innerHTML = `
                    <strong>Contact Details:</strong><br>
                    Name: ${contact.name}<br>
                    Email: ${contact.email || 'N/A'}<br>
                    Phone: ${contact.phone || 'N/A'}<br>
                    Company: ${contact.company_name || 'N/A'}<br>
                    Activities: ${contact.activities?.length || 0}<br>
                    Tasks: ${contact.tasks?.length || 0}<br>
                    Meetings: ${contact.meetings?.length || 0}
                `;
            } catch (error) {
                document.getElementById('contactResult').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        function editContact(contactId) {
            const newName = prompt('Enter new name for contact:');
            if (!newName) return;

            fetch(`/api/contacts/${contactId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Contact updated successfully!');
                    loadContacts(); // Refresh the list
                }
            })
            .catch(error => alert('Error: ' + error.message));
        }

        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) return;

            try {
                const response = await fetch(`/api/contacts/${contactId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Contact deleted successfully!');
                    loadContacts(); // Refresh the list
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function openContactProfile(contactId) {
            try {
                const response = await fetch(`/api/contacts/${contactId}`);
                const contact = await response.json();
                
                if (contact.error) {
                    document.getElementById('contactResult').innerHTML = `<strong>Error:</strong> ${contact.error}`;
                    return;
                }

                // Create a detailed contact profile display
                document.getElementById('contactResult').innerHTML = `
                    <div style="border: 2px solid #3498db; padding: 15px; border-radius: 8px;">
                        <h3>${contact.name}</h3>
                        <p><strong>Email:</strong> ${contact.email || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${contact.phone || 'N/A'}</p>
                        <p><strong>Mobile:</strong> ${contact.mobile || 'N/A'}</p>
                        <p><strong>Company:</strong> ${contact.company_name || 'N/A'}</p>
                        <p><strong>Position:</strong> ${contact.position || 'N/A'}</p>
                        <p><strong>Lead Status:</strong> ${contact.lead_status || 'N/A'}</p>
                        <p><strong>Priority:</strong> ${contact.priority || 'N/A'}</p>
                        <p><strong>Last Contacted:</strong> ${contact.last_contacted ? new Date(contact.last_contacted).toLocaleString() : 'Never'}</p>
                        <p><strong>Activities:</strong> ${contact.activities?.length || 0}</p>
                        <p><strong>Tasks:</strong> ${contact.tasks?.length || 0}</p>
                        <p><strong>Meetings:</strong> ${contact.meetings?.length || 0}</p>
                        <button onclick="editContact(${contact.id})" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; margin-right: 10px;">Edit Contact</button>
                        <button onclick="deleteContact(${contact.id})" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px;">Delete Contact</button>
                    </div>
                `;
            } catch (error) {
                document.getElementById('contactResult').innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        function testContactSelection() {
            // Test the selection functionality
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                if (index < 2) { // Select first 2 contacts
                    checkbox.checked = true;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        }

        // Auto-load contacts on page load
        window.addEventListener('DOMContentLoaded', () => {
            testApiHealth();
            loadContacts();
        });
    </script>
</body>
</html>